# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Next.js 14 frontend for Optimizely CMS SaaS using Optimizely Graph for content delivery. Uses App Router, React Server Components, and GraphQL codegen for type-safe data fetching.

## Essential Commands

```bash
yarn compile          # Generate GraphQL types (required before dev/build)
yarn dev              # Start development server
yarn build            # Build for production + register webhook
yarn build:full       # GraphQL codegen + build + webhook
yarn lint             # Run ESLint
yarn format           # Run Prettier
```

## Architecture

### Content Routing
- `src/app/[[...path]]/page.tsx` - Catch-all route renders CMS content by path
- `src/app/preview/page.tsx` - On-page editing/preview mode (no caching)
- Content fetched via `getContentByPath` from generated GraphQL functions

### Component System
CMS components in `src/components/cms/` organized by base type:
- `page/` - Routable pages (HomePage, CMSPage, StartPage)
- `component/` - Reusable blocks (HeroBlock, ServicesBlock, etc.)
- `experience/` - Visual Builder experiences (BlankExperience, SEOExperience)
- `image/`, `video/`, `media/` - Media components

Each component folder contains:
- `index.tsx` - React component using `CmsComponent<FragmentType>`
- `*.opti-type.json` - CMS content type definition
- `*.{category}.graphql` - Fragment for data requirements

### Component Registration
Factory in `src/components/factory.ts` builds `ComponentTypeDictionary` from all CMS components. Category indexes (`component/index.ts`, `page/index.ts`, etc.) are auto-generated by CLI.

### GraphQL Codegen
- Config: `codegen.ts` with `@remkoj/optimizely-graph-functions/preset`
- Output: `src/gql/` (generated types, fragments, SDK functions)
- Fragments auto-injected into PageData/BlockData based on file path patterns
- Fragment naming: `{TypeName}Data` (e.g., `HeroBlockData`)
- File naming: `{TypeName}.{category}.graphql` (e.g., `HeroBlock.component.graphql`)

### Channel Configuration
`src/channel.ts` defines website channel (domain, locales, CMS URL). Throws error if `OPTIMIZELY_CMS_URL` not configured.

### Shared Utilities
- `src/lib/domain.ts` - Domain resolution for sitemap/robots
- `src/lib/utils.ts` - Tailwind `cn()` utility
- `src/api.ts` - Shared GraphQL client/SDK instances

## Creating New Content Types

1. Create folder: `src/components/cms/{category}/{TypeName}/`
2. Create `{TypeName}.opti-type.json` with content type definition
3. Create `{TypeName}.{category}.graphql` with `fragment {TypeName}Data on {TypeName}`
4. Create `index.tsx` implementing `CmsComponent<{TypeName}DataFragment>`
5. Run `yarn compile` to regenerate GraphQL types
6. Factory registration happens automatically via CLI-generated indexes

## Key SDK Imports

```typescript
// For blocks/components
import { CmsEditable, type CmsComponent } from "@remkoj/optimizely-cms-react/rsc";

// For pages/experiences
import { type OptimizelyNextPage as CmsComponent } from "@remkoj/optimizely-cms-nextjs";

// For Visual Builder composition
import { OptimizelyComposition, isNode } from "@remkoj/optimizely-cms-react/rsc";
```

## Environment Variables

Required in `.env.local` (see `.env.example`):
- `OPTIMIZELY_CMS_URL` - CMS instance URL
- `OPTIMIZELY_CMS_CLIENT_ID/SECRET` - API credentials
- `OPTIMIZELY_GRAPH_SECRET/APP_KEY/SINGLE_KEY` - Graph authentication
- `OPTIMIZELY_PUBLISH_TOKEN` - Webhook authentication token

## Path Alias

`@/*` maps to `./src/*`

## Important Notes

- All CMS components are Server Components (no `'use client'`)
- Run `yarn compile` after creating/modifying `.graphql` files
- Content webhook doesn't work locally; use `/api/content/publish?token=$TOKEN` for manual revalidation
- Draft mode switches client to HMAC auth automatically
